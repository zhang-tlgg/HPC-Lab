# 小作业四：CUDA 并行策略 实验报告

张天乐 2018011038

### 一、时间测试

测量结果见附录。

### 二、分析

#### 对于这个程序

##### 1. 如何设置 thread block size 才可以达到最好的效果？为什么？

观察发现，block size 在适当的规模，并且 block_size_y 可以被 H = 10000 整除时效果最好。因为当 block_size_y 可以被 H = 10000 整除时，block 在 y 轴上不会有空余，负载更加均衡。

##### 2. Shared memory 总是带来优化吗？如果不是，为什么？

不是。因为 Shared memory 方案有以下几点不同：

- 写入 Shared memory 会有额外的耗时

- block 边界上的线程会计算 block 外的数值，并写入 Shared memory

这些都有额外耗时。当 block size 很小时，Shared memory 较少的时间小于额外耗时，导致负优化。

##### 3. Shared memory 在什么 thread block size 下有效果，什么时候没有？

在 block size 大于一定规模后有效果。在实验的测试数据中，只有 block size = 32 × 1 没有效果，其余都有效果。

#### 对于给定程序

##### 1. 应该如何设置 thread block size？

block size 在一个合适的范围，并且尽量将任务均匀分配给 block，不要出现某一 block 有大量空余的情况。

##### 2. 应该如何决定 shared memory 的使用？

如果使用 shared memory 带来的额外开销（额外的计算以及写入）小于访问 shared memory 的时间减少，可以使用 shared memory 。以本程序为例，使用 shared memory 会有额外的计算和写入 shared memory 的时间，但访问 shared memory 比 global memory 快。当 block size 大于某一范围，前者的耗时小于后者减小的时间，使用 shared memory 更好。

| block size | 不使用 shared memory 时间 | 使用 shared memory 时间 |
| ---------- | -------------------- | ------------------- |
| 32 × 1     | 9.46927 ms           | 10.1262 ms          |
| 32 × 2     | 7.61455 ms           | 6.54281 ms          |
| 32 × 3     | 7.62627 ms           | 5.82706 ms          |
| 32 × 4     | 7.64216 ms           | 5.53483 ms          |
| 32 × 5     | 7.70065 ms           | 5.81103 ms          |
| 32 × 6     | 7.70694 ms           | 5.73162 ms          |
| 32 × 7     | 7.68738 ms           | 5.59383 ms          |
| 32 × 8     | 7.70238 ms           | 5.49899 ms          |
| 32 × 9     | 7.7228 ms            | 5.54395 ms          |
| 32 × 10    | 7.75599 ms           | 5.63631 ms          |
| 32 × 11    | 7.85186 ms           | 5.98437 ms          |
| 32 × 12    | 7.77037 ms           | 5.64821 ms          |
| 32 × 13    | 8.01428 ms           | 6.22435 ms          |
| 32 × 14    | 7.85643 ms           | 5.88976 ms          |
| 32 × 15    | 7.83352 ms           | 5.68875 ms          |
| 32 × 16    | 7.788 ms             | 5.50021 ms          |
| 32 × 17    | 8.19952 ms           | 6.35103 ms          |
| 32 × 18    | 8.03423 ms           | 6.03165 ms          |
| 32 × 19    | 8.02716 ms           | 5.95362 ms          |
| 32 × 20    | 7.93054 ms           | 5.7696 ms           |
| 32 × 21    | 7.93021 ms           | 5.71716 ms          |
| 32 × 22    | 8.40957 ms           | 7.07206 ms          |
| 32 × 23    | 8.37494 ms           | 6.81177 ms          |
| 32 × 24    | 8.31542 ms           | 6.816 ms            |
| 32 × 25    | 8.31957 ms           | 6.56502 ms          |
| 32 × 26    | 8.22727 ms           | 6.48568 ms          |
| 32 × 27    | 7.9911 ms            | 6.23081 ms          |
| 32 × 28    | 7.99496 ms           | 6.29012 ms          |
| 32 × 29    | 7.99925 ms           | 6.0032 ms           |
| 32 × 30    | 7.95896 ms           | 6.07589 ms          |
| 32 × 31    | 7.94879 ms           | 5.91399 ms          |
| 32 × 32    | 7.91233 ms           | 5.99209 ms          |
| 64 × 1     | 7.61323 ms           | 6.45586 ms          |
| 64 × 2     | 7.63469 ms           | 5.51541 ms          |
| 64 × 3     | 7.67952 ms           | 5.56636 ms          |
| 64 × 4     | 7.68748 ms           | 5.32164 ms          |
| 64 × 5     | 7.74464 ms           | 5.59986 ms          |
| 64 × 6     | 7.77209 ms           | 5.61664 ms          |
| 64 × 7     | 7.8865 ms            | 5.88828 ms          |
| 64 × 8     | 7.81487 ms           | 5.40846 ms          |
| 64 × 9     | 8.0816 ms            | 6.09385 ms          |
| 64 × 10    | 7.96555 ms           | 5.70012 ms          |
| 64 × 11    | 8.50909 ms           | 7.09339 ms          |
| 64 × 12    | 8.41676 ms           | 6.72038 ms          |
| 64 × 13    | 8.28847 ms           | 6.28463 ms          |
| 64 × 14    | 8.02423 ms           | 6.03921 ms          |
| 64 × 15    | 8.00776 ms           | 5.89114 ms          |
| 64 × 16    | 7.95505 ms           | 5.77403 ms          |
| 96 × 1     | 7.6192 ms            | 5.84267 ms          |
| 96 × 2     | 7.65448 ms           | 5.48536 ms          |
| 96 × 3     | 7.67161 ms           | 5.31963 ms          |
| 96 × 4     | 7.73822 ms           | 5.48865 ms          |
| 96 × 5     | 7.79578 ms           | 5.56146 ms          |
| 96 × 6     | 8.01137 ms           | 5.99657 ms          |
| 96 × 7     | 7.8864 ms            | 5.54496 ms          |
| 96 × 8     | 8.40777 ms           | 6.64126 ms          |
| 96 × 9     | 8.02241 ms           | 6.09 ms             |
| 96 × 10    | 7.9975 ms            | 5.75226 ms          |
| 128 × 1    | 7.62807 ms           | 5.61919 ms          |
| 128 × 2    | 7.66422 ms           | 5.24474 ms          |
| 128 × 3    | 7.74374 ms           | 5.50992 ms          |
| 128 × 4    | 7.76557 ms           | 5.29724 ms          |
| 128 × 5    | 7.88354 ms           | 5.6034 ms           |
| 128 × 6    | 8.30265 ms           | 6.56163 ms          |
| 128 × 7    | 8.00134 ms           | 5.92866 ms          |
| 128 × 8    | 7.94641 ms           | 5.59851 ms          |
| 160 × 1    | 7.63997 ms           | 5.70889 ms          |
| 160 × 2    | 7.69634 ms           | 5.40003 ms          |
| 160 × 3    | 7.77502 ms           | 5.47817 ms          |
| 160 × 4    | 7.84039 ms           | 5.55379 ms          |
| 160 × 5    | 8.13925 ms           | 6.38828 ms          |
| 160 × 6    | 7.92345 ms           | 5.71088 ms          |
| 192 × 1    | 7.66087 ms           | 5.67044 ms          |
| 192 × 2    | 7.7315 ms            | 5.4148 ms           |
| 192 × 3    | 7.94923 ms           | 5.90878 ms          |
| 192 × 4    | 8.15964 ms           | 6.51242 ms          |
| 192 × 5    | 7.95312 ms           | 5.61444 ms          |
| 224 × 1    | 7.64681 ms           | 5.52268 ms          |
| 224 × 2    | 7.79577 ms           | 5.65137 ms          |
| 224 × 3    | 7.81625 ms           | 5.3764 ms           |
| 224 × 4    | 7.91749 ms           | 5.94472 ms          |
| 256 × 1    | 7.6658 ms            | 5.47009 ms          |
| 256 × 2    | 7.7578 ms            | 5.2606 ms           |
| 256 × 3    | 8.10711 ms           | 6.32269 ms          |
| 256 × 4    | 7.91922 ms           | 5.35192 ms          |
| 288 × 1    | 7.66212 ms           | 5.49211 ms          |
| 288 × 2    | 7.92765 ms           | 5.86535 ms          |
| 288 × 3    | 7.9749 ms            | 5.89645 ms          |
| 320 × 1    | 7.70402 ms           | 5.59635 ms          |
| 320 × 2    | 7.86769 ms           | 5.5126 ms           |
| 320 × 3    | 7.92927 ms           | 5.42239 ms          |
| 352 × 1    | 7.77494 ms           | 5.906 ms            |
| 352 × 2    | 8.10952 ms           | 6.55422 ms          |
| 384 × 1    | 7.73271 ms           | 5.63052 ms          |
| 384 × 2    | 8.05314 ms           | 6.16919 ms          |
| 416 × 1    | 7.87539 ms           | 6.17385 ms          |
| 416 × 2    | 8.01546 ms           | 5.91406 ms          |
| 448 × 1    | 7.81043 ms           | 5.84659 ms          |
| 448 × 2    | 7.90443 ms           | 5.66339 ms          |
| 480 × 1    | 7.749 ms             | 5.64188 ms          |
| 480 × 2    | 7.85173 ms           | 5.48382 ms          |
| 512 × 1    | 7.74075 ms           | 5.50856 ms          |
| 512 × 2    | 7.87238 ms           | 5.23104 ms          |
| 544 × 1    | 7.97872 ms           | 6.28012 ms          |
| 576 × 1    | 7.93002 ms           | 6.06085 ms          |
| 608 × 1    | 7.93527 ms           | 6.01388 ms          |
| 640 × 1    | 7.87092 ms           | 5.82651 ms          |
| 672 × 1    | 7.82428 ms           | 5.63804 ms          |
| 704 × 1    | 8.13412 ms           | 6.82647 ms          |
| 736 × 1    | 8.06116 ms           | 6.56032 ms          |
| 768 × 1    | 8.06588 ms           | 6.55321 ms          |
| 800 × 1    | 7.97581 ms           | 6.36629 ms          |
| 832 × 1    | 8.01208 ms           | 6.30057 ms          |
| 864 × 1    | 7.95691 ms           | 6.28209 ms          |
| 896 × 1    | 7.91702 ms           | 6.05341 ms          |
| 928 × 1    | 7.84451 ms           | 5.99189 ms          |
| 960 × 1    | 7.91248 ms           | 5.98027 ms          |
| 992 × 1    | 7.99543 ms           | 5.97197 ms          |
| 1024 × 1   | 7.84327 ms           | 5.75298 ms          |
